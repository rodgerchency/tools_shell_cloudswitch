#!/bin/bash
# gutil - GCP Utility CLI (fzf interactive version)
# DESC: Interactive CLI to run GCP-specific and shared K8S commands

set -euo pipefail

SCRIPT_DIR=$(dirname "$(dirname "$(dirname "${BASH_SOURCE[0]}")")")

# è¼‰å…¥å…±ç”¨å·¥å…·
source "$SCRIPT_DIR/common/utils.sh"

# æª¢æŸ¥å¿…è¦å‘½ä»¤
for cmd in gcloud kubectl fzf; do
    check_command "$cmd"
done

# æŒ‡ä»¤ç›®éŒ„é™£åˆ—
CMD_DIRS=(
    "$SCRIPT_DIR/gcp/bin/cmds"
    "$SCRIPT_DIR/common/bin/cmds"
)

# é¡¯ç¤ºåŠ è¼‰çš„ç›®éŒ„
# echo "ğŸ”¹ CMD_DIRS:"
# for d in "${CMD_DIRS[@]}"; do
#     echo "  $d"
# done

# æ”¶é›† commands å’Œæè¿°
menu=()
for dir in "${CMD_DIRS[@]}"; do
    [[ ! -d "$dir" ]] && continue
    shopt -s nullglob
    for f in "$dir"/*.sh; do
        [[ ! -f "$f" ]] && continue
        cmd=$(basename "$f" .sh)
        desc=$(grep -m1 '^# DESC:' "$f" | cut -d':' -f2- | xargs)
        [[ -z "$desc" ]] && desc="(no description)"
        menu+=("$cmd|$desc|$f")
        # debug log
        # echo "DEBUG: Added command -> $cmd|$desc|$f"
    done
    shopt -u nullglob
done

# å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æŒ‡ä»¤
if [[ ${#menu[@]} -eq 0 ]]; then
    warn "æœªæ‰¾åˆ°ä»»ä½•å¯åŸ·è¡ŒæŒ‡ä»¤ã€‚"
    return 0
fi

# é¡¯ç¤ºé¸å–®
echo ""
echo "ğŸ”§ GCP Utility CLI"
echo "========================================="
echo "è«‹é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½ï¼š"

# fzf åªé¡¯ç¤ºåç¨±å’Œæè¿°ï¼Œä½†ä¿ç•™å®Œæ•´æ¬„ä½
selected=$(printf "%s\n" "${menu[@]}" | \
    fzf --ansi --height=15 --border --prompt="Select > " --info=inline --with-nth=1,2)

# é˜²æ­¢ Ctrl+C æˆ–ç„¡é¸æ“‡æ™‚ç›´æ¥é€€å‡º
[[ -z "$selected" ]] && { warn "å·²å–æ¶ˆã€‚"; return 0; }

# è§£æé¸æ“‡
cmd_name=$(echo "$selected" | awk -F'|' '{print $1}')
cmd_path=$(echo "$selected" | awk -F'|' '{print $3}')

# debug log
# echo "DEBUG: cmd_name=$cmd_name"
# echo "DEBUG: cmd_path=$cmd_path"

[[ ! -f "$cmd_path" ]] && { error "æ‰¾ä¸åˆ°æŒ‡ä»¤æª”æ¡ˆï¼š$cmd_path"; return 1; }

echo ""
info "ğŸš€ åŸ·è¡ŒåŠŸèƒ½ï¼š${cmd_name}"
echo "-----------------------------------------"

# åŸ·è¡ŒæŒ‡ä»¤
bash "$cmd_path"
