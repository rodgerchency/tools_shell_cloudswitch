#!/bin/bash
# autil - AWS Utility CLI (fzf interactive version)
# DESC: Interactive CLI to run AWS-specific and shared K8S commands

SCRIPT_DIR=$(dirname "$(dirname "$(dirname "${BASH_SOURCE[0]}")")")
# è¼‰å…¥å…±ç”¨å·¥å…·
source "$SCRIPT_DIR/common/utils.sh"

IS_SOURCED=false
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
  IS_SOURCED=true
fi

# æŒ‡ä»¤ç›®éŒ„é™£åˆ—
CMD_DIRS=(
    "$SCRIPT_DIR/aws/bin/cmds"
    "$SCRIPT_DIR/common/bin/cmds"
)

# é¡¯ç¤ºåŠ è¼‰çš„ç›®éŒ„
# echo "ğŸ”¹ CMD_DIRS:"
# for d in "${CMD_DIRS[@]}"; do
#     echo "  $d"
# done

# æ”¶é›† commands å’Œæè¿°
menu=()
# è¿­ä»£æ‰€æœ‰çš„æŒ‡ä»¤ç›®éŒ„
for dir in "${CMD_DIRS[@]}"; do
    # æª¢æŸ¥ç›®éŒ„æ˜¯å¦å­˜åœ¨
    if [[ ! -d "$dir" ]]; then
        warn "Commands directory not found: $dir"
        continue
    fi
    
    # ä½¿ç”¨ for è¿´åœˆä¾†éæ­·ç›®éŒ„ä¸‹çš„æ‰€æœ‰ .sh æª”æ¡ˆ
    for f in "$dir"/*.sh; do
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦çœŸå¯¦å­˜åœ¨ (é¿å…æ‰¾ä¸åˆ°æ™‚éæ­·åˆ° '*.sh')
        [[ ! -f "$f" ]] && continue 

        # å–å¾—æŒ‡ä»¤åç¨± (ä¾‹å¦‚ï¼šsetup_aws_profile)
        cmd=$(basename "$f" .sh)
        
        # å–å¾—æè¿°ï¼Œä½¿ç”¨ grep/cut/xargs ä¿æŒä¸è®Š
        desc=$(grep -m1 '^# DESC:' "$f" | cut -d':' -f2- | xargs)
        
        # å¦‚æœæè¿°ç‚ºç©ºï¼Œè¨­å®šé è¨­å€¼
        [[ -z "$desc" ]] && desc="(no description)"
        
        # å°‡çµæœå­˜å…¥é™£åˆ— (æŒ‡ä»¤å|æè¿°|è·¯å¾‘)
        menu+=("$cmd|$desc|$f")
    done
done

# å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æŒ‡ä»¤
if [[ ${#menu[@]} -eq 0 ]]; then
    warn "æœªæ‰¾åˆ°ä»»ä½•å¯åŸ·è¡ŒæŒ‡ä»¤ã€‚"
    return 0
fi

# é¡¯ç¤ºé¸å–®
echo ""
echo "ğŸ”§ AWS Utility CLI"
echo "========================================="
echo "è«‹é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½ï¼š"

# fzf åªé¡¯ç¤ºç¬¬ä¸€ã€ç¬¬äºŒæ¬„ (name & desc)ï¼Œä½†ä¿ç•™ç¬¬ä¸‰æ¬„ (path)
selected=$(printf "%s\n" "${menu[@]}" | \
  fzf --ansi --height=15 --border --prompt="Select > " --info=inline --with-nth=1,2)

# é˜²æ­¢ Ctrl+C æˆ–ç„¡é¸æ“‡æ™‚ç›´æ¥é€€å‡º
[[ -z "$selected" ]] && { warn "å·²å–æ¶ˆã€‚"; return 0; }

# è§£æé¸æ“‡
cmd_name=$(echo "$selected" | awk -F'|' '{print $1}')
cmd_path=$(echo "$selected" | awk -F'|' '{print $3}')

# debug log
echo "DEBUG: cmd_name=$cmd_name"
echo "DEBUG: cmd_path=$cmd_path"

[[ ! -f "$cmd_path" ]] && { error "æ‰¾ä¸åˆ°æŒ‡ä»¤æª”æ¡ˆï¼š$cmd_path"; return 1; }

echo ""
info "åŸ·è¡ŒåŠŸèƒ½ï¼š${cmd_name}"
echo "-----------------------------------------"

# è®€å– MODEï¼Œé è¨­ NORMAL
mode=$(grep -m1 '^# MODE:' "$cmd_path" | cut -d':' -f2 | xargs)
mode=${mode:-NORMAL}

if [[ "$mode" == "EXPORT" ]]; then
  if [[ "$IS_SOURCED" == true ]]; then
    result=$(bash "$cmd_path")
    eval "$result"
    success "ç’°å¢ƒè®Šæ•¸å·²å¥—ç”¨"
  else
    error "æ­¤æŒ‡ä»¤éœ€è¦ä½¿ç”¨: source autil"
    return 1
  fi
else
  bash "$cmd_path"
fi
